{% extends 'base.html.twig' %}

{% block title %}Anasayfa{% endblock %}

{% block body %}

<!-- banner -->
<div class="banner">
    <img src="images/photos/banner.jpg"  class="img-responsive" alt="slide">
    <div class="welcome-message">
        <div class="wrap-info">
            <div class="information">
                <h1  class="animated fadeInDown">Bitirme 2 Otel Otomasyonu</h1>
            </div>
            <a href="#information" class="arrow-nav scroll wowload fadeInDownBig"><i class="fa fa-angle-down"></i></a>
        </div>
    </div>
</div>
<!-- banner-->
<!-- reservation-information -->
<div id="information" class="spacer reserve-info ">
    <div class="container">
        <div class="row">
            <div class="col-sm-5 col-md-12">
                <h3>Rezervasyon</h3>
                <form id="rezervasyonForm" role="form" class="wowload fadeInRight">
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-6">
                                <label for="province">İl</label>
                                <select id="province" class="form-control">
                                </select>
                            </div>
                            <div class="col-xs-6">
                                <label for="county">İlçe</label>
                                <select id="county" class="form-control">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-6">
                                <label for="star">Yıldız</label>
                                <select class="form-control">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                            <div class="col-xs-6">
                                <label for="name">Oteller</label>
                                <select id="hotels" class="form-control">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-6">
                                <label for="roomType">Odalar</label>
                                <select id="rooms" class="form-control">
                                </select>
                            </div>
                            <div class="col-xs-6">
                                <label for="count">Kişi Sayısı</label>
                                <input id="capacity" class="form-control" value="1" min="1" type="number">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-6">
                                <label id="lblgr" for="entranceDate">Giriş Tarihi</label>
                                <input id="entranceDate" type="date" class="form-control">
                            </div>
                            <div class="col-xs-6">
                                <label for="leaveDate">Çıkış Tarihi</label>
                                <input id="leaveDate" type="date" class="form-control">
                            </div>
                        </div>
                    </div>
                    <button id="btnRez" class="btn-default">Rezerve Et</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- reservation-information -->

     <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Rezervasyon Bilgileri</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="rezerveEtForm" enctype="multipart/form-data" method="post" action="/rezerve-et">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <input type="hidden" id="userId" />
                                    <label>Rezervasyon Yapan</label>
                                    <input type="text" id="userName" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <input type="hidden" id="hotelId" />
                                    <label>Otel Adı</label>
                                    <input type="text"  id="hotelName" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <input type="hidden" id="roomId" />
                                    <label>Oda Türü</label>
                                    <input type="text" id="roomType" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label>Oda Boyutu</label>
                                    <input type="text" id="roomSize" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label>Rezerve Edilen Kişi Sayısı</label>
                                    <input type="text" id="roomPeopleCount" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label>Birim Fiyat</label>
                                    <input type="text" id="roomPrice" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label>Tutar</label>
                                    <input type="text" id="bookingPrice" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label>Otele Giriş Tarihi</label>
                                    <input type="date" id="entDate" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label>Otelden Çıkış Tarihi</label>
                                    <input type="date" id="leaDate" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                            <button id="btnBooking" type="submit" class="btn btn-success">Rezerve Et</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



<!-- services -->
<div class="spacer services wowload fadeInUp">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <!-- OtelCarousel -->
                <div class="carousel slide" data-ride="carousel">
                    <div id="hotelCarousel" class="carousel-inner">
                        <!-- Otellerin resimleri gelecek
                        <div class="item active"><img src="images/photos/8.jpg" class="img-responsive" alt="slide"></div>
                        <div class="item  height-full"><img src="images/photos/9.jpg"  class="img-responsive" alt="slide"></div>
                        <div class="item  height-full"><img src="images/photos/10.jpg"  class="img-responsive" alt="slide"></div>
                        Otellerin resimleri gelecek -->
                    </div>
                    <!-- Controls -->
                    <a class="left carousel-control" href="#hotelCarousel" role="button" data-slide="prev"><i class="fa fa-angle-left"></i></a>
                    <a class="right carousel-control" href="#hotelCarousel" role="button" data-slide="next"><i class="fa fa-angle-right"></i></a>
                </div>
                <!-- OtelCarousel-->
                <div class="caption">Oteller<a href="{{ path ('hotels') }}" class="pull-right"><i class="fa fa-edit"></i></a></div>
            </div>
            <!-- OdaCarousel -->
            <div class="col-sm-6">
                <!-- OdaCarousel -->
                <div class="carousel slide" data-ride="carousel">
                    <div id="roomCarousel" class="carousel-inner">
                        <!-- Odaların resimleri gelecek
                        <div class="item active"><img src="images/photos/8.jpg" class="img-responsive" alt="slide"></div>
                        <div class="item  height-full"><img src="images/photos/9.jpg"  class="img-responsive" alt="slide"></div>
                        <div class="item  height-full"><img src="images/photos/10.jpg"  class="img-responsive" alt="slide"></div>
                         Odaların resimleri gelecek -->
                    </div>
                    <!-- Controls -->
                    <a class="left carousel-control" href="#roomCarousel" role="button" data-slide="prev"><i class="fa fa-angle-left"></i></a>
                    <a class="right carousel-control" href="#roomCarousel" role="button" data-slide="next"><i class="fa fa-angle-right"></i></a>
                </div>
                <!-- OdaCarousel -->
                <div class="caption">Odalar</div>
            </div>
        </div>
    </div>
</div>
<!-- services -->
{% endblock %}

{% block javascripts %}

    <script language="JavaScript">

        function setCapacity(rooms,roomId) {
            var capacity = 0;
            $.each(rooms,function (i,room) {
                if(room.id == roomId){
                    capacity = room.capacity;
                }
            });
            return capacity;
        }

        function getHotels(hotels,rooms,il,ilce){
            var htmlCounty ="";
            var htmlHotel ="";
            var htmlRoom = "";
            $.each(hotels,function (i,item) {
                if(item.province === il) {
                    htmlCounty+="<option value='"+item.county+"'>"+item.county+"</option>";
                    htmlHotel+="<option value='"+item.id+"'>"+item.name+"</option>";
                    $.each(rooms,function (i,room) {
                        if(room.hotel_id === item.id){
                            htmlRoom+="<option value='"+room.id+"'>"+room.type+"</option>";
                        }
                    })
                }
                $('#county').html(htmlCounty);
                $('#hotels').html(htmlHotel);
                $('#rooms').html(htmlRoom);
            });

            var roomId = $('#rooms option:selected')[0].value;


            document.getElementById('capacity').max = setCapacity(rooms,roomId);
        }

        $( document ).ready(function() {
            document.getElementById('entranceDate').min = new Date().toISOString().split("T")[0];
            document.getElementById('leaveDate').min = new Date().toISOString().split("T")[0];

            var ed = document.getElementById('entranceDate');
            ed.onchange = function(){
                document.getElementById('leaveDate').min = ed.value;
            };
            $.ajax({
                url:'hotelsRooms',
                methos:'post',
                success:function (data) {
                    var hotels = jQuery.parseJSON(data).hotels;
                    var rooms = jQuery.parseJSON(data).rooms;

                    $.each(hotels,function (i,item) {
                        $('#province').append($('<option>',{
                            value: item.province,
                            text: item.province
                        }))
                    });
                    getHotels(hotels,rooms,$('#province')[0].value,"");
                    $('#province').change(function () {

                        getHotels(hotels,rooms,$(this)[0].value,"");
                    });
                    $('#rooms').change(function () {
                        document.getElementById('capacity').value=1;
                        document.getElementById('capacity').max = setCapacity(rooms,document.getElementById('rooms').value);
                    });

                    $('#btnRez').click(function (event) {
                        event.preventDefault();
                        var roomType = "";
                        var roomSize = 0;
                        var birimFiyat = 0;
                        var toplamFiyat = 0;
                        $.each(rooms,function (i,room) {
                            if(room.id == document.getElementById('rooms').value){
                                roomType=room.type;
                                roomSize=room.size;
                                birimFiyat=room.price;
                            }
                        });
                        var start = new Date($('#entranceDate').val());
                        var end = new Date($('#leaveDate').val());
                        var diff = new Date(end - start);
                        var days = diff/1000/60/60/24;

                        toplamFiyat = birimFiyat*document.getElementById('capacity').value*days;
                        console.log(days);

                        $.ajax({
                            url:'/get-user',
                            method:'post',
                            success:function (data) {
                                if(data.userId == null || data.userId == ""){
                                    window.location = "/login";
                                }
                                if ($('#entranceDate').val() == "" || $('#leaveDate').val() == "" || toplamFiyat <= 0){
                                      alert("Giriş ve çıkış tarihleri geçersiz");
                                }
                                else{
                                    $('#exampleModal').modal();
                                    document.getElementById('userId').value = data.userId;
                                    document.getElementById('userName').value = data.userFirstName +' '+data.userLastName;
                                    document.getElementById('hotelName').value = document.getElementById('hotels').textContent;
                                    document.getElementById('hotelId').value =  document.getElementById('hotels').value;
                                    document.getElementById('roomId').value = document.getElementById('rooms').value;
                                    document.getElementById('roomType').value = roomType;
                                    document.getElementById('roomSize').value = roomSize;
                                    document.getElementById('roomPeopleCount').value = document.getElementById('capacity').value;
                                    document.getElementById('roomPrice').value = birimFiyat;
                                    document.getElementById('bookingPrice').value = toplamFiyat;
                                    if(document.getElementById('entranceDate').value != ""){
                                        document.getElementById('entDate').value = document.getElementById('entranceDate').value;
                                    }
                                    if(document.getElementById('leaveDate').value != ""){
                                        document.getElementById('leaDate').value = document.getElementById('leaveDate').value;
                                    }
                                }
                            }
                        });
                    });

                    $("#rezerveEtForm").submit(function( event ) {
                        event.preventDefault();
                        $.ajax({
                            url: '/rezerve-et',
                            method: 'post',
                            dataType: 'json',
                            async: true,
                            data:  {
                                userId: document.getElementById('userId').value,
                                hotelId: document.getElementById('hotelId').value,
                                roomId: document.getElementById('roomId').value,
                                peopleCount: document.getElementById('roomPeopleCount').value,
                                price: document.getElementById('bookingPrice').value,
                                entranceDate: document.getElementById('entDate').value,
                                leaveDate: document.getElementById('leaDate').value
                            },
                            success: function (data, status) {
                                console.log(data);
                            },
                            error: function (xhr, textStatus, errorThrown) {
                                console.log('Ajax request failed.');
                            }
                        });
                    });
                },
                error:function (data) {
                    console.log("error");
                }
            });
        });

    </script>


    <script language="JavaScript">


        $.ajax({
            url:'/images',
            method:'post',
            success:function (data) {
                var resimler = jQuery.parseJSON(data).images;
                var img_link = jQuery.parseJSON(data).img_link;

                var roomc='<div class="item active"><img src="http://'+img_link+resimler[0].url+'" class="img-responsive" alt="slide"></div>';
                var html ='<div class="item active"><img src="http://'+img_link+resimler[0].url+'" class="img-responsive" alt="slide"></div>';
                for(var i=1;i<resimler.length;i++){
                    if(resimler[i].room_id != undefined){
                        html+='<div class="item  height-full"><img src="http://'+img_link+resimler[i].url+'"  class="img-responsive" alt="slide"></div>';
                        roomc+='<div class="item  height-full"><img src="http://'+img_link+resimler[i].url+'"  class="img-responsive" alt="slide"></div>';
                    }
                    else{
                        html+='<div class="item  height-full"><img src="http://'+img_link+resimler[i].url+'"  class="img-responsive" alt="slide"></div>';
                    }
                }
                $(html).appendTo('#hotelCarousel');
                $(roomc).appendTo('#roomCarousel');
            },
            error:function (data) {
                console.log(data);
            }
        });

    </script>

{% endblock %}